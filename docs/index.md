# Introduction

DesmondTools have a set of command-line scripts and a python library written to make setting up the molecular dynamics simulations easier for Desmond.

## Install

```bash
$ pip install desmondtools
```

## What is Multisim Class?

The following code examples from `test/test_multisim.py` demonstrate the functionality of the Multisim class.


```py
from desmondtools import Multisim

def test_Multisim_variable():
    # parse_string returns ['barostat.tau']
    o1 = Multisim.variable.parse_string("barostat.tau")[0]
    o2 = Multisim.variable.parse_string("barostat  .tau")[0]
    assert o1 == o2
    

def test_Multisim_expression_1():
    i = "task {} simulate { meta = [{a=1 b=3 c=[7 8 9]}] f = {} } simulate {n=2} simulate {n = 3}"
    D = Multisim(string=i).to_dot()
    assert D.simulate[0].meta[0].b == str(3)
    assert D.simulate[0].meta[0].c[1] == str(8)
    assert D.simulate[-1].n == str(3)


def test_Multisim_expression_2():
    i = "simulate { effect_if = [[ a ] b ] }"
    D = Multisim(string=i).to_dot()
    assert D.simulate.effect_if[0] == ['a']
    assert D.simulate.effect_if[1] == 'b'
    

def test_Multisim_expression_3():
    i = """ensemble = {
        brownie = {
            delta_max = 0.1
        }
        class = NVT
        method = Brownie
        thermostat = {
            tau = 1.0
        }
    }"""
    D = Multisim(string=i)
    assert D.dot.ensemble.brownie.delta_max == str(0.1)
    
    # assert D.dot.ensemble.class == 'NVT'
    #                       ^^^^^
    # SyntaxError: invalid syntax
    # 'class' is reserved word in python and raises SyntaxError
    # use instead .['class']
    assert D.dot.ensemble['class'] == 'NVT' # <--- it does not raise SyntaxError

    assert D.dot.ensemble.method == 'Brownie'
    assert D.dot.ensemble.thermostat.tau == str(1.0)
    D.write()


def test_Multisim_expression_4():
    i = """task {
        task = "desmond:auto"
    }
    simulate {
        title = "NPT and no restraints, 24ps"
        effect_if = [[ "@*.*.annealing" ] 'annealing = off temperature = "@*.*.temperature[0][0]"' ]
        time = 24
        ensemble = {
            class = NPT
            method = Langevin
            thermostat.tau = 0.1
            barostat.tau = 2.0
        }
        eneseq.interval = 0.3
        trajectory.center = solute
    }
    simulate {
        meta = {
            cv = [
                { 
                    atom = [0 0 0 0] 
                    type = dihedral 
                    wall = 0  
                    width = 5.0 
                }
            ]
            cv_name = "$JOBNAME$[_replica$REPLICA$].cvseq"
            first = 0.0
            height = 0.03
            interval = 0.09
            name = "$JOBNAME$[_replica$REPLICA$].kerseq"
        }
    }
    """

    D = Multisim(string=i)
    
    assert len(D.dot.simulate[0].effect_if) == 2
    assert len(D.dot.simulate[0].effect_if[0]) == 1
    assert D.dot.simulate[0].ensemble.method == 'Langevin'
    assert D.dot.simulate[0].ensemble.barostat.tau == str(2.0)
    assert D.dot.simulate[0].eneseq.interval == str(0.3)
    assert D.dot.simulate[0].trajectory.center == 'solute' # <---
    
    assert len(D.dot.simulate[1].meta.cv) == 1
    assert len(D.dot.simulate[1].meta.cv[0].atom) == 4
    assert D.dot.simulate[1].meta.height == str(0.03)
    assert D.dot.simulate[-1].meta.cv[0].wall == str(0)
    
    D.dot.simulate[0].ensemble.barostat.tau = 2.1
    assert D.dot.simulate[0].ensemble.barostat.tau == 2.1

    D.dot.simulate[1].meta.height = 0.06
    assert D.dot.simulate[1].meta.height == 0.06
    
    D.dot.simulate[-1].meta.cv[0].wall = 50.0
    assert D.dot.simulate[-1].meta.cv[0].wall == 50.0
    

def test_Multisim_expression_5():
    D= Multisim(template="desmond-md.msj")
    D.write()
```
## Caution

Some keywords in the `.msj` or `.cfg` files may conflict with the reserved python syntax. In the below example, accessing the `class` variable by directly using the `.dot` expression such as `D.dot.ensemble.class = 'NVT'` would raise a `SyntaxError` because `class` is a reserved word in Python. However, you can avoid the error by using a dictionary type access such as `D.dot.ensemble['class'] = 'NVT'`.

```pre
    ensemble = {
        brownie = {
            delta_max = 0.1
        }
        class = NVT
        method = Brownie
        thermostat = {
            tau = 1.0
        }
    }
```

## Usage

The `desmondtools.Multisim` class facilitates reading and modifying Schrodinger Desmond `.msj` and `.cfg` files, which are typically generated by Schrodinger Maestro GUI task panels. By using a simple Python script with `desmondtools`, you can efficiently prepare and set up multiple MD simulations without repeatedly launching Maestro or manually editing files. The example below demonstrates how to modify or create the contents of `.msj` and `.cfg` files using the `.dot` attribute of a `Multisim` instance.


```python
from desmondtools import Multisim

# read template .msj and .cfg
md_msj = Multisim(template="desmond-md.msj")
md_cfg = Multisim(template="desmond-md.cfg")

with open(msj_file,"w") as msj:
    # modify desmond msj template
    md_msj.dot.simulate[-1].cfg_file = cfg_file_basename
    
    # Setting up restraints using the restraints keyword:
    # https://www.schrodinger.com/kb/332119
    if args.posres_force > 0.0:
        # print the restraints in the multisim log file
        md_msj.dot.simulate[-1].print_restraint = 'true'

        # add the new terms defined in "restraints.new" to existing restraints.
        # The default is restraints.existing = ignore which will 
        # delete existing terms before adding any new ones.
        # md_msj.dot.simulate[-1].restraints.existing = 'retain'

        md_msj.dot.simulate[-1].restraints.new = [
            {
                'name'              : 'posre_harm',
                'atoms'             : [ f'"{args.posres}"' ],
                'force_constants'   : [ args.posres_force, ] * 3,
            }
            ]
        # force constants in the x, y, and z direction
    
    # writing modified msj
    md_msj.write(msj)

with open(cfg_file,"w") as cfg:
    # read and modify desmond cfg template
    md_cfg.dot.randomize_velocity.seed = random.randint(1000, 9999)
    md_cfg.dot.time = total_simulation_time
    md_cfg.dot.temperature = t_schedule
    md_cfg.dot.trajectory.interval = args.interval
    # wring modified cfg
    md_cfg.write(cfg)
```

Below are examples of `.msj` and `.cfg` files:

```pre
# .msj file example (part)

task {
   task = "desmond:auto"
   set_family = {
      desmond = {
         checkpt.write_last_step = no
      }
   }
}

simulate {
   title       = "Brownian Dynamics NVT, T = 10 K, small timesteps, ..."
   annealing   = off
   time        = 100
   timestep    = [0.001 0.001 0.003 ]
   temperature = 10.0
   ensemble = {
      class = "NVT"
      method = "Brownie"
      brownie = {
         delta_max = 0.1
      }
   }
   restrain = {
      atom = "solute_heavy_atom"
      force_constant = 50.0
   }
}

simulate {
   effect_if   = [["==" "-gpu" "@*.*.jlaunch_opt[-1]"] 'ensemble.method = Langevin']
   title       = "NVT, T = 10 K, small timesteps, ..."
   annealing   = off
   time        = 12
   timestep    = [0.001 0.001 0.003]
   temperature = 10.0
   restrain    = { atom = solute_heavy_atom force_constant = 50.0 }
   ensemble    = {
      class  = NVT
      method = Berendsen
      thermostat.tau = 0.1
   }

   randomize_velocity.interval = 1.0
   eneseq.interval             = 0.3
   trajectory.center           = []
}
```

```
# .cfg file example (part)

randomize_velocity = {
   first = 0.0
   interval = inf
   seed = 2967
   temperature = "@*.temperature"
}
restrain = none
simbox = {
   first = 0.0
   interval = 1.2
   name = "$JOBNAME$[_replica$REPLICA$]_simbox.dat"
}
surface_tension = 0.0
taper = false
temperature = [
   [300.0 0 ]
]
time = 100000.0
timestep = [0.002 0.002 0.006 ]
```

## Command-Line Interface

Command-Line Interfaces (CLI) are built on the `Multisim` class. Some CLIs require Schrodinger Python API.


| Command-line interface | Description |
| ---------------------- | ----------- |
| batch-desmond-mdinfo   | Check running MD simulations |
| batch-desmond-maeinfo  | Show info of .mae/.maegz file(s) |
| batch-desmond-cmsinfo  | Show info of .cms file(s) |
| batch-desmond-setup    | Batch Prepare MD systems |
| batch-desmond-min      | Batch Setup energy minimizations |
| batch-desmond-md       | Batch Setup MD simulations |
| batch-desmond-metad    | Batch Setup metadynamics |
| batch-desmond-report   | Batch Generate reports |
| batch-desmond-pli      | Batch Analyze protein-ligand interactions |
| batch-desmond-distance | Batch Analyze distance |
| batch-desmond-dihedral | Batch Analyze dihedral angles |
| batch-desmond-ligrmsd  | Batch Analyze ligand rmsd |
| batch-desmond-rg       | Batch Analyze radius of gyration |
| batch-desmond-rmsx  | Batch Analyze RMSD and ligand RMSF |
| batch-desmond-mmgbsa  | Batch Analyze trajectory MMGBSA |

For more helps, `$ command --help`.

## Metadynamics

### Types of Collective Variables

| type    | Description                  |  Default Width | Wall | Floor | Atom sites |
| ----    | ---------------------------- | ------------- | ---- | ----- | ---------- |
| dist    |    Distance                               | 0.05 Å     |     yes  |   yes  |  2 |
| angle   |    Angle                                  | 2.5°       |    yes   |  yes   |  3 |
| dihedral  |   Dihedral                              |  5.0°      |      no  |    no  |  4 |
| rgyr      |  Radius of gyration                     | 0.1 Å      |     no   |   no   |  1 |
| rgyr_mass |  Mass-weighted radius of gyration       | 0.1 Å      |     no   |   no   |  1 |
| rmsd      |  RMSD from aligned starting structure   | 0.1 Å      |     no   |   no   |  1 |
| rmsd_symm |  Symmetry aware RMSD                    | 0.1 Å      |     no   |   no   |  1 |
| zdist     |  Distance along the z axis              | 0.05 Å     |     yes  |   yes  |  1 |
| zdist0    |  Absolute distance along the z axis     | 0.1 Å      |     yes  |   yes  |  1 |
| whim1     |  WHIM1 - first principal moment [35]    | 0.5 Å2     |     no   |   no   |  1 |
| whim2     |  WHIM2 - second principal moment [35]   | 0.25 Å2    |     no   |   no   |  1 |

### Examples of Collective Variables


``` py
distance:
    cv = [
        {atom = ["res. UNK" "res. 849" ]
        type = dist
        wall = 40
        floor = 10
        width = 0.05
        }
    ]

dihedral:
    cv = [
        {atom = [404 406 407 415 ]
        type = dihedral
        width = 5.0
        }
        {atom = [406 407 415 417 ]
        type = dihedral
        width = 5.0
        }
    ]

zdist(membrane):
    cv = [
        {atom = ["res. UNK"]
        type = zdist
        width = 0.05
        wall = 20
        floor = 5
        }
        ]

rmsd:
    cv = [
        {atom = ["res. UNK" "res. 849" ]
        type = rmsd
        width = 0.1
        }
    ]
```
    

### Well-Tempered Metadynamics

In well-tempered metadynamics, the height of the deployed Gaussians are rescaled (decreased) during simulation time by:
omega_0 * exp(-V/(kB * ΔT))
Where omega_0 is the initial hill height, V is the bias potential and the denominator in the exponential, kB * ΔT,  
is the bias factor (kTemp). During well-tempered metadynamics, the dynamics of the system are effectively accelerated 
(without heating up the system) up to T + ΔT, where T is the chosen MD simulation temperature. 
The choice of the bias factor value is guided by the highest barrier in the simulation system 
which the well-tempered metadynamics run should overcome. Here are some suggestions, 
assuming that the initial hill height ω0 (height parameter in the Metadynamics panel) has been set to 0.3 kcal/mol:

| Max. barrier height (kcal/mol) | kTemp (kcal/mol) |
| ------------------------------ | ---------------- |
| 3                              | 1.7              |
| 6                              | 3.4              |
| 10                             | 5.6              |
| 15                             | 8.4              |
| 20                             | 11.2             |

## Extending Simulations

See https://www.schrodinger.com/kb/788642 for extending metadynamics simulation.

::: desmondtools.Multisim
    options:
        toc_label: "Multisim"

::: desmondtools.cli
    options:
        toc_label: "CLI"

::: desmondtools.Event
    options:
        toc_label: "Event"

::: desmondtools.Interaction
    options:
        toc_label: "Interaction"